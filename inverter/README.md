# Tim Nolan's grid-tie inverter


The files in this directory were originally developed by Tim Nolan.  I found
them on
[his web site](http://www.timnolan.com/index.php?page=solar-grid-intertie-inverter).

The website is no longer available, and I cannot confirm the license of the original code at this point.

## Project Technical Description

An inverter is basically an electronic device that takes a DC input voltage and
converts it to an AC output voltage. My design takes a 12V DC input from my
solar panels (two 50w panels in parallel) and converts it 120V AC at 60Hz which
is the power that most home appliances use. A grid-intertie inverter connects up
to and external AC power system and matches it's internal AC sinewave to the
external AC sinewave to allow the inverter to feed power into the external
system. My inverter design also includes a maximum power point tracking
algorithm to maximize the power drawn from the solar panel. The inverter uses 4
MOSFETs in a full bridge configuration to convert the input DC to a low voltage
AC. The low voltage AC is converted to high voltage AC by a toroidal transformer
with a 1:30 ratio. The high voltage AC is rectified by 4 diodes in a full bridge
configuration. The resulting waveform is smoothed by an inductor and capacitor
filter and then converted to an AC sinewave by the final 4 MOSFET switches. A
relay is used to connect the generated AC to the external AC. I used an Atmel
AT90PWM3B processor to control the inverter. This processor has some nice
feature that make is well suited to digital power control. Please see the
hardware description and software comments for a more detailed explanation of
the project.

## Schematics

These schematics were created with EagleCAD v4.16r1. I've included the Eagle
schematics and the pdf version of the schematic and the board layout file. This
project is divided into two printed circuit board. The low voltage board (12v
DC) is the inverter control board. The high voltage board (120v AC) is the
inverter power board.

Inverter Control Board:

- `inverter_control.sch`
- `inverter_control.brd`
- `inveter_control.pdf`
- `inverter_control_parts.txt`

Inverter Power Board:

- `inverter_power.sch`
- `inverter_power.brd`
- `inverter_power.pdf`
- `inverter_power_parts.txt`

## Hardware Description

### Low Voltage Section (inverter\_control.sch)

The inverter is divided into two printed circuit board. The `inverter_control.sch`
describes the low voltage circuit board. U4 is the microprocessor. It is an
Atmel AT90PWM3B. I choose the AT90PWM3B because it has a very power and flexible
PWM control section that they call a Power Stage Controller. The processor has a
serial interface to talk to the PC using a MAX232A (IC2) and 9 pin D connector
(X5). The ISP programming connector for the JTAGICE mk II is the 6 pin .1"
(SV4). X4 and Q5 are for PWM fan speed control but this feature is not
implemented yet. S1 dipswitch is for user software configuration and
debugging. U3 is an LM35 analog temperature sensor. This temperature sensor is
mounted next to the MOSFETs on the heatsink. It is used by software to make sure
the MOSFETs don't overheat. IC5 is a 74LS32 Quad OR gate and IC1 is a 74LS14 Hex
Inverter. These gates are used to read back the zero crossing signals from the
high power board. The OR gate is connected to a Timer Input Capture pin so the
length of the zero crossing signal can be calculated. Q1, Q2, Q3 and Q4 are the
MOSFETs (IRLIZ44 N-fets) that make up the full bridge switcher. This is the
heart of the low voltage section. The full bridge switcher takes the DC input
voltage from the solar panels and switches it into high frequency AC to pass on
to the transformer to generate high voltage AC. The MOSFETs are driven by two
IR2104s MOSFET drivers (U1 and U2). The IR2104s use bootstrap capacitors C9 and
C10 to generate the voltages needed to drive the high side MOSFETs Q1 and
Q3. C14 and C15 are the large input capacitors used to smooth out the input
solar power. R32 and R33 make up the voltage divider to drop down the input
solar voltage so it can be read by the processor A/D. IC8 is a LT1787 that use
the current sensing resistor R30 to measure the input solar current. Using the
solar panel voltage and input current the processor can calculate the solar
panel wattage that is used in the Peak Power Tracking algorithm. IC9 is the
linear regulator used to generate 5V from the input solar voltage. SV1 is the
connector for the control and sensing signals to the inverter\_power pcb. X3 is
the connector for the high frequency low voltage AC generated by the full bridge
to the isolation tranformer primary. The transformer is a xxxx ferrite
toriod. The primary is wound with 3 turns of 16ga magnet wire. The secondary is
wound with 60 turns 20ga magnet wire which give the transformer a ratio of
1:20. The transformer also has two more isolated secondary windings of 4
turns. These generate two seperate isolated power supplies for the sensing
circuits on the inverter\_power pcb.

### High Voltage Section (inverter\_power.sch)

The inverter power pcb takes the high frequency high voltage AC from the
transformer and turns it into 120V AC power synced up to the external AC. There
are also isolated sections that sense the zero crossing and the voltage of the
external AC. The low voltage control and sensing signals to and from the
inverter control pcb go through a 16 pin ribbon cable to the SV1 connector. All
the low voltage signals to and from the inverter control board are isolated from
the high voltage AC on the inverter power board by optoisolators. The high
voltage high frequency AC from the transformer secondary comes in on connector
X1. It is snubbed by R14 and C25 and then rectified by 4 diodes in a bridge
configuration D22, D23, D24 and D25. The pcb also has an active rectifier with 4
MOSFETSs Q6, Q7, Q8 and Q9 but these are not used and not installed. Their
MOSFET drivers U8 and U9 and control signal optoisolators OK4A, OK4B and OK5B
are also not used and not installed. After the diode rectifer the signal is
snubbed again by D21, R19 and C32. Then it's smoothed by L2 ad C27. There are
also connectors X5 and X6 so that different values of inductor capacitor filters
can be experimented with. Normally at this point the high frequency and high
voltage AC signal from the transformer secondary would be rectified and smoothed
out to a high voltage DC value. In most inverter topologies this DC voltage
would be chopped and inverted into a 120V 60Hz AC sinewave by the MOSFETs in the
output bridge(Q10, Q11, Q12 and Q13). This means the output MOSFETs have to
switch at a very high frequency (>30kHz) to recreate a sinewave that can be
smoothed by the output filters. Because the MOSFETs are switching a high voltage
at a high switching rate I found in my experimentation that they get very hot. I
went back and did some more research and found a slightly different topology
that alleviated this problem. Instead of a constant duty cycle the low voltage
bridge varies the duty cycle of the high frequency AC in a 60Hz sine wave
pattern. After transformer voltage boost rectification and smoothing instead of
a constant high voltage DC you get a positive only 60Hz sinewave varying voltage
(insert oscilliscope image). Since most of the work of generating the sinewave
is already done the output bridge only as to switch at the 60Hz rate to unfold
the waveform to flip one half of it to negative (insert oscilliscope
picture). Since the output bridge is switching much slower it runs much
cooler. Once the 120V 60Hz AC is generated it can not be connected to the
external grid AC until it is matched in phase and voltage. The relay K1 keeps
the voltage isolated until the processor says it is correct. The output bridge
is driven by two MOSFET drivers U10 and U11. They are isolated from the low
voltage control signals by the optoisolators OK3A, OK3B and OK5A. The MOSFET
drivers and optos are powered by the isolated power supply generated by the
auxilary winding on the transformer AUX1. The winding is connected to X2 and
rectified filtered by B2 and C20. IC7 is the voltage regulator that generates
5v. To sync the interally generated AC to the external AC the zero crossing of
the external AC must be sensed. That's done by the two optoisolators OK2A and
OK2B. Two low voltage signals are generated that bracket the zero crossing of
the external AC. Measuring the external AC voltage and sending it back the
signal isolated to the low voltage side is tricky. I ended up using a small 8
pin Atmel microprocessor the ATtiny45. An isolated power supply was generated
using another isolated winding on the transformer AUX2. This comes in on
connector X4 and is rectified and filtered by B1 and C1. IC3 generates 5V that
is filtered by C11. This 5V is used to power IC4 which is the ATtiny45
microprocessor. SV2 is the programming connector and LED3 is the heartbeat
LED. The external AC is rectified by B3 so we get it all as a positive
signal. Then it is voltage divided and filtered by R10, R11 and C12 so the input
voltage is under 5v to be read by the processor A/D. The processor reads the
input voltage and calculates the RMS AC voltage (see the software listing
sw\_sensev5.c for how this is done). The value of the external AC RMS voltage is
then transmitted as a clocked serial signal through the optoisolators OK1A and
OK1B to get it to the main processor on the isolated low voltage control pcb.


## Software

The main processor for the inverter is an Atmel AT90PWM3B. I used the free
development system from Atmel AVR Studio 4 and installed the open source GCC
compiler package WinAVR. This has allowed me to write all my software for this
project in C using this free development enviroment. I did buy Atmel's JTAGICE
mk II that allows me to download, program and debug the processor in my system
using the in circuit programming port on the processor. I've included the source
code for the AT90PWM3B main processor and the small ATtiny45 processor that used
to read the AC voltage. Please see the comments in the code for explanation of
the inverter software.

AT90PWM3B Main Processor Source Code: `sinewave4v10.c`

ATtiny45 Auxilary Processor Source Code: `sw_sensev5.c`
